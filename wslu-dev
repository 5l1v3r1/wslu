#!/usr/bin/env bash

# wslu - Windows 10 linux Subsystem Utility
# <https://github.com/patrick330602/wslu>

# Copyright(c) 2017 Patrick Wu J M <wotingwu@live.com>

# For more help for wslu, visit the following site:
# http://garage.patrickwu.cf/man/wslu

# data segment
wslu_version=0.18

## color
red=`tput setaf 1`
green=`tput setaf 2`
brown=`tput setaf 3`
blue=`tput setaf 4`
purple=`tput setaf 5`
cyan=`tput setaf 6`
yellow=`tput setaf 7`
orange=`tput setaf 166`
bold=`tput bold`
reset=`tput sgr0`

## indicator
info="${green}[info]${reset} "
error="${red}[error]${reset} "
warn="${orange}[warn]${reset} "
debug="${cyan}[debug]${reset} "

## constants
help_short="wslu [help|version|shortcut|install|system|fetch] <options>"
help="Windows 10 Linux Subsystem Utility
Usage: $help_short

For more help for wslu, visit the following site:
http://garage.patrickwu.cf/wslu"

## Windows side data
path_win()
{
	new_path="$(echo $1 | sed -e 's|\\|\\\\|g')"
	echo $new_path
}
path_linux()
{
	new_path="$(echo $1 | sed -e 's|\\|/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/mnt/\L\1\E/\2|')"
	echo $new_path
}
desktop_path=`reg.exe query "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders" /v "Desktop" 2>&1 | sed -n 3p | awk '{ print $3 }' | sed -e 's|\s||g'`
tmp_path=`(cd /mnt/c && cmd.exe /k "echo %TMP% && exit") 2>&1`
appdata_path=`(cd /mnt/c && cmd.exe /k "echo %APPDATA% && exit") 2>&1`
programfile_path=`(cd /mnt/c && cmd.exe /k "echo %ProgramFiles% && exit") 2>&1`
windows_build=`reg.exe query "HKLM\Software\Microsoft\Windows NT\CurrentVersion" /v "CurrentBuild" 2>&1 | egrep -o '([0-9]{5})'`

## system info
hostname="$(hostname)"
release="$(lsb_release -d -s)"
kernel="$(uname -sr)"
uptime="$(uptime -p | sed 's/up //')"
packages="$((packages+=$(dpkg --get-selections | grep -cv deinstall$)))"
build="Windows 10 Build $windows_build"
shell="$(basename ${SHELL})"

##functions

# commands
## general
case $1 in
	v|version)echo "wslu v$wslu_version";;
	h|help)echo "$help";;
## package segment
	install)
		tmp_version="$(lsb_release -c -s)"
		tpath_win="$(path_win $tmp_path)"
		tpath_linux="$(path_linux $tmp_path)"
		apath_win="$(path_win $appdata_path)"
		apath_linux="$(path_linux $appdata_path)"
		ppath_win="$(path_win $programfile_path)"
		if [[ -n $3 ]]; then
			echo "${info}Adding repository..."
			sudo add-apt-repository -y $3
			echo "${info}Updating source..."
			sudo apt-get update
			echo "${info}Installing $2...."
			sudo apt-get install -y $2
			echo "${info}$2 installed."
			exit
		elif  [[ "$2" == "pulseaudio" ]]; then
			echo "${info}checking dependency..."
			hash wget 2>/dev/null || (echo "${warn}wget not installed. Installing..."; sudo apt-get install wget)
			hash unzip 2>/dev/null || (echo "${warn}unzip not installed. Installing..."; sudo apt-get install unzip)
			case $tmp_version in
				trusty)
					echo "${info}Your are on $tmp_version. Adding corresponding repo..."
					sudo add-apt-repository -y ppa:aseering/wsl-pulseaudio
					;;
				xenial) 
					echo "${info}Your are on $tmp_version. Adding corresponding repo..."
					sudo add-apt-repository -y ppa:therealkenc/wsl-pulseaudio
					;;
				*)	echo "${error}Unsupported distro. Aborted."; exit 40;;
			esac
			echo "${info}Updating source..."
			sudo apt-get update
			echo "${info}Installing PulseAudio Linux client..."
			sudo apt-get install -y pulseaudio
			echo "${info}Applying PulseAusio Linux client fix..."
			sudo sed -i 's/; default-server =/default-server = 127.0.0.1/' /etc/pulse/client.conf
			echo "${info}Downloading PulseAudio Windows client..."
			wget -cO $tpath_linux/pulseaudio.zip http://bosmans.ch/pulseaudio/pulseaudio-1.1.zip
			echo "${info}Extracting files...."
			cmd.exe /k "md \"$tpath_win\\\\pulseaudio\" && exit"
			unzip -o $tpath_linux/pulseaudio.zip -d $tpath_linux/pulseaudio
			echo "${info}Installing PulseAudio Windows client..."
			cmd.exe /k "md \"$apath_win\\\\PulseAudio\" && exit"
			xcopy.exe /e "$tpath_win\\\\pulseaudio" "$apath_win\\\\PulseAudio"
			echo "${info}Setting PulseAudio to run at startup..."
			apath_trimmed="$(echo $appdata_path | tr -d '[:space:]')"
			echo -e "set ws=wscript.createobject(\"wscript.shell\")\r\n" > "$apath_linux/Microsoft/Windows/Start Menu/Programs/Startup/start_pulseaudio.vbe"
			echo "ws.run \"$apath_trimmed\PulseAudio\bin\pulseaudio.exe --exit-idle-time=-1\",0" >> "$apath_linux/Microsoft/Windows/Start Menu/Programs/Startup/start_pulseaudio.vbe"
			CR=$(printf '\r')
			sed "s/\$/$CR/" "$apath_linux/Microsoft/Windows/Start Menu/Programs/Startup/start_pulseaudio.vbe"
			echo "${info}Adding recommended settings..."
			echo "load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" >> "$apath_linux/PulseAudio/etc/pulse/default.pa"
			echo "${info}PulseAudio installed. Restart to take effect."
			echo "${warn}DO NOT allow PulseAudio access to any of your networks if prompted."
		# VcXsrv Installer
		elif [[ "$2" == "vcxsrv" ]]; then
			echo "${info}Downloading VcXsrv..."
			if [[ -f $tpath_linux/vcxsrv.exe ]]; then
				rm -r $tpath_linux/vcxsrv.exe
			fi
			wget -cO $tpath_linux/vcxsrv.exe http://downloads.sourceforge.net/project/vcxsrv/vcxsrv/1.19.2.0/vcxsrv-64.1.19.2.0.installer.exe
			echo "${info}Setting VcXsrv to run at startup..."
			powershell.exe "\$s=(New-Object -COM WScript.Shell).CreateShortcut('$apath_win\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\VcXsrv.lnk');\$s.TargetPath='$ppath_win\\VcXsrv\\vcxsrv.exe';\$s.Arguments=':0 -ac -terminate -lesspointer -multiwindow -clipboard -wgl';\$s.Save();"
			echo "${info}Start installer. After Installation, please restart to take effect."
			cmd.exe /k "start "$tpath_win\\VcXsrv.exe" && exit"
			echo "${warn}DO NOT allow VcXsrv access to any of your networks if prompted."
		else
			echo "${error} No input or invalid input, aborting"
			exit 20
		fi
	;;
## shortcut segment
	shortcut)
		if [[ -n $2 ]]; then
			cname="$2"
			tpath="$(path_win $tmp_path)"
			dpath="$(path_linux $desktop_path)"
			powershell.exe "\$s=(New-Object -COM WScript.Shell).CreateShortcut('$tpath\\$cname.lnk');\$s.TargetPath='C:\\Windows\\System32\\bash.exe';\$s.Arguments='-c \`\"DISPLAY=:0 $cname\`\"';\$s.Save();"
			tpath="$(path_linux $tmp_path)"
			mv $tpath/$cname.lnk $dpath
			echo "${info}Create shortcut ${cname}.lnk successful"
		else
			echo "${error}No input, aborting"
			exit 21
		fi
	;;
## system segment
	system)
		case $2 in
			-B|--build)echo $build;;
			-R|--release)echo $release;;
			-K|--kernel)echo $kernel;;
			-P|--package)echo $packages;;
			*)echo "$release on $build (kernel:$kernel)";;
		esac
	;;
## fetch segment
	fetch)
		cat <<EOF

${cyan} /\$\$      /\$\$  /\$\$\$\$\$\$  /\$\$       ${red}Windows 10 Linux Subsytem${reset}
${cyan}| \$\$  /\$ | \$\$ /\$\$__  \$\$| \$\$	  ${red}${USER}${reset}@${red}${hostname}${reset}
${cyan}| \$\$ /\$\$\$| \$\$| \$\$${reset}  ${cyan}\\__/| \$\$${reset}       ${red}BUILD:${reset}	${build}
${cyan}| \$\$${reset}${cyan}/\$\$${reset} ${cyan}\$\$${reset} ${cyan}\$\$${reset}${cyan}|  \$\$\$\$\$\$${reset} ${cyan}| \$\$${reset}       ${red}RELEASE:${reset}	${release}
${cyan}| \$\$\$\$${reset}${cyan}_  \$\$\$\$${reset} ${cyan}\\____  \$\$${reset}${cyan}| \$\$${reset}	  ${red}KERNEL:${reset}	${kernel}
${cyan}| \$\$\$${reset}${cyan}/ \\  \$\$\$${reset} ${cyan}/\$\$${reset}  ${cyan}\\ \$\$${reset}${cyan}| \$\$${reset}	  ${red}UPTIME:${reset}	${uptime}
${cyan}| \$\$${reset}${cyan}/   \\  \$\$${reset}${cyan}|  \$\$\$\$\$\$${reset}${cyan}/| \$\$\$\$\$\$\$\$${reset} ${red}SHELL:${reset}	${shell}
${cyan}|__/     \\__/ \\______/ |________/${reset} ${red}PACKAGES:${reset}	${packages}

EOF
	;;
	*)echo "$help_short"; exit 20;;
esac

